name: Deploy Sabina Akter Portfolio

on:
    push:
        branches: ["main"]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Build Docker image
              run: |
                  docker build -t sabina-akter:v1 -f Dockerfile .

            - name: Setup SSH
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY_SABINA_PORTFOLIO }}
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  # Write the private key
                  echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa

                  # Add to SSH agent
                  eval "$(ssh-agent -s)"
                  ssh-add ~/.ssh/id_rsa

                  # Test connection
                  ssh -o StrictHostKeyChecking=no \
                    ${{ secrets.USER_SABINA_PORTFOLIO }}@${{ secrets.HOST_SABINA_PORTFOLIO }} \
                    "echo 'SSH connection successful'"

            - name: Transfer and Deploy
              env:
                  SSH_USER: ${{ secrets.USER_SABINA_PORTFOLIO }}
                  SSH_HOST: ${{ secrets.HOST_SABINA_PORTFOLIO }}
              run: |
                  # Save Docker image
                  docker save sabina-akter:v1 -o sabina-akter-v1.tar

                  # Transfer to EC2
                  scp -o StrictHostKeyChecking=no \
                    sabina-akter-v1.tar \
                    $SSH_USER@$SSH_HOST:/tmp/

                  # Deploy on EC2
                  ssh -o StrictHostKeyChecking=no \
                    $SSH_USER@$SSH_HOST "
                    sudo docker load -i /tmp/sabina-akter-v1.tar
                    sudo docker stop sabina-akter || true
                    sudo docker rm sabina-akter || true
                    sudo docker run -d \
                      --name sabina-akter \
                      --restart unless-stopped \
                      -p 3000:3000 \
                      sabina-akter:v1
                    sudo docker ps
                  "
