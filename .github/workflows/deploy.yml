name: Deploy Sabina Akter Portfolio

on:
  push:
    branches:
      - "main"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t sabina-akter:v1 -f Dockerfile .
          echo "Build complete. Images:"
          docker images | grep sabina-akter

      - name: Test Docker image locally
        run: |
          echo "Testing Docker image locally..."
          docker run --rm -d -p 3000:3000 --name test-container sabina-akter:v1
          sleep 5
          echo "Testing container..."
          docker ps
          curl -f http://localhost:3000 || echo "Local test failed (might be OK)"
          docker stop test-container

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY_SABINA_PORTFOLIO }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Test connection
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.USER_SABINA_PORTFOLIO }}@${{ secrets.HOST_SABINA_PORTFOLIO }} \
              "echo 'SSH connection successful'; whoami; pwd"

      - name: Save and transfer Docker image
        run: |
          # Save image
          docker save sabina-akter:v1 -o sabina-akter-v1.tar
          ls -lh *.tar

          # Transfer to EC2
          scp -o StrictHostKeyChecking=no \
              sabina-akter-v1.tar \
              ${{ secrets.USER_SABINA_PORTFOLIO }}@${{ secrets.HOST_SABINA_PORTFOLIO }}:/tmp/

      - name: Deploy and Debug on EC2
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.USER_SABINA_PORTFOLIO }}@${{ secrets.HOST_SABINA_PORTFOLIO }} "
            
            echo '=== EC2 System Info ==='
            echo 'Hostname:' \$(hostname)
            echo 'User:' \$(whoami)
            echo 'Working directory:' \$(pwd)
            
            echo '=== Docker Status ==='
            sudo docker --version
            sudo systemctl status docker --no-pager || true
            
            echo '=== Current Containers ==='
            sudo docker ps -a
            
            echo '=== Current Images ==='
            sudo docker images
            
            echo '=== Network Status ==='
            sudo netstat -tlnp | grep :3000 || echo 'Port 3000 not in use'
            
            # Stop and clean up old container
            echo '=== Cleaning up old container ==='
            sudo docker stop sabina-akter 2>/dev/null || echo 'No running container to stop'
            sudo docker rm sabina-akter 2>/dev/null || echo 'No container to remove'
            
            # Load new image
            echo '=== Loading new image ==='
            sudo docker load -i /tmp/sabina-akter-v1.tar
            
            # Verify image loaded
            echo '=== Verifying image ==='
            sudo docker images | grep sabina-akter
            
            # Run container with more verbose settings
            echo '=== Starting new container ==='
            sudo docker run -d \
              --name sabina-akter \
              --restart unless-stopped \
              -p 3000:3000 \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              -e HOSTNAME=0.0.0.0 \
              sabina-akter:v1
            
            # Wait a bit
            sleep 5
            
            echo '=== Container Status ==='
            sudo docker ps
            
            echo '=== Container Logs ==='
            sudo docker logs sabina-akter --tail 30
            
            echo '=== Checking container health ==='
            sudo docker exec sabina-akter ps aux || echo 'Cannot exec into container'
            
            echo '=== Testing from inside EC2 ==='
            curl -f http://localhost:3000 && echo '✅ Application is running internally' || \
              echo '❌ Application not responding internally'
            
            echo '=== Checking firewall ==='
            sudo ufw status || echo 'UFW not installed'
            
            echo '=== Checking EC2 public access ==='
            PUBLIC_IP=\$(curl -s ifconfig.me)
            echo 'Public IP:' \$PUBLIC_IP
            echo 'Try accessing: http://'\$PUBLIC_IP':3000'
            
            # Clean up
            rm /tmp/sabina-akter-v1.tar
          "