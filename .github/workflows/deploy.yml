name: Deploy Sabina Akter Portfolio

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t sabina-akter:v1 -f Dockerfile .
          echo "Docker image built successfully"

      - name: Setup SSH with Complete Debugging
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY_SABINA_PORTFOLIO }}
          SSH_USER: ${{ secrets.USER_SABINA_PORTFOLIO }}
          SSH_HOST: ${{ secrets.HOST_SABINA_PORTFOLIO }}
        run: |
          echo "=== SETTING UP SSH ==="

          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write the private key with proper handling
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa

          # Fix any Windows line endings
          sed -i 's/\r$//' ~/.ssh/id_rsa

          # Ensure proper permissions
          chmod 600 ~/.ssh/id_rsa

          echo "=== DEBUG INFO ==="
          echo "SSH_USER: $SSH_USER"
          echo "SSH_HOST: $SSH_HOST"
          echo "Key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
          echo "First 3 lines of key file:"
          head -3 ~/.ssh/id_rsa
          echo "Last 3 lines of key file:"
          tail -3 ~/.ssh/id_rsa

          # Generate and show public key
          echo "=== PUBLIC KEY GENERATED ==="
          ssh-keygen -y -f ~/.ssh/id_rsa

          # Start SSH agent
          echo "=== STARTING SSH AGENT ==="
          eval "$(ssh-agent -s)"

          # Add key to agent
          ssh-add ~/.ssh/id_rsa
          echo "Keys in agent:"
          ssh-add -l

          # Create SSH config
          cat > ~/.ssh/config <<EOF
          Host deploy-target
            HostName $SSH_HOST
            User $SSH_USER
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel DEBUG3
          EOF

          chmod 600 ~/.ssh/config

          echo "=== TESTING SSH CONNECTION ==="

          # Test 1: Simple echo command
          if ssh -v deploy-target "echo 'SSH Test 1: Connection successful'; whoami; pwd"; then
            echo "✅ SSH connection successful"
          else
            echo "❌ SSH connection failed"
            
            # Test 2: Without config
            echo "=== TRYING WITHOUT CONFIG ==="
            ssh -v -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $SSH_USER@$SSH_HOST \
              "echo 'Direct test'" || echo "Direct test failed"
            
            exit 1
          fi

      - name: Save and Transfer Docker Image
        env:
          SSH_USER: ${{ secrets.USER_SABINA_PORTFOLIO }}
          SSH_HOST: ${{ secrets.HOST_SABINA_PORTFOLIO }}
        run: |
          echo "=== SAVING DOCKER IMAGE ==="
          docker save sabina-akter:v1 -o sabina-akter-v1.tar
          ls -lh *.tar

          echo "=== TRANSFERRING TO EC2 ==="
          scp -v -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            sabina-akter-v1.tar \
            $SSH_USER@$SSH_HOST:/tmp/

          echo "✅ Transfer complete"

      - name: Deploy on EC2
        run: |
          ssh $SSH_USER@$SSH_HOST << 'EOF'
            docker pull mayinuddinmunna/sabina-akter
            docker stop sabina-akter || true
            docker rm sabina-akter || true
            docker run -d \
              --name sabina-akter \
              --restart unless-stopped \
              -p 127.0.0.1:3000:3000 \
              mayinuddinmunna/sabina-akter
          EOF
